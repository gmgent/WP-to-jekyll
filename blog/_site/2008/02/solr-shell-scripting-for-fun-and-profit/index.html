<!DOCTYPE html>
<html dir="ltr" lang="en-US">
    <head>
        <meta charset="UTF-8" />
        <title>solr shell scripting for fun and profit | Krister Axel</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0; maximum-scale=1.0; user-scalable=yes" name="viewport"/>

<!-- Custom Favicon -->
<link rel="shortcut icon" href="http://blog.kristeraxel.com/wp-content/uploads/2012/11/favicon.ico"/>

<!-- style sheets -->
<link rel="stylesheet" type="text/css" href="/css/style.css" media="all" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?2.9.0/build/reset-fonts-grids/reset-fonts-grids.css&2.9.0/build/base/base-min.css"> 
        <script src="/audiojs/audio.min.js"></script>
    </head>

    <body>
	<!-- the id on the containing div determines the page width. -->
	<!-- #doc = 750px; #doc2 = 950px; #doc3 = 100%; #doc4 = 974px -->
	<div id="doc">					
		<div id="hd">
			<div id="header" class="col-full">

   
   <div id="logo">
        <a href="/" title="spotlights in the wild">
            <img src="http://blog.kristeraxel.com/wp-content/uploads/2012/11/header11.jpg" alt="Krister Axel" />
        </a>
   </div><!-- /#logo -->
   
</div><!-- /#header -->
<div id="navigation" class="col-full">
	<ul id="main-nav" class="nav">
		<li id="menu-item-1" class="menu-item">
		    <a href="/" >the latest</a></li>
		
		<li id="menu-item-2" class="menu-item">
	        <a href="/Archive/">Archive</a></li>
	
		<li id="menu-item-3" class="menu-item">
		    <a href="/Info/" >Info</a></li>

		<li id="menu-item-4" class="menu-item">
            <a href="/Press/" >Press</a></li>

		<li id="menu-item-5" class="menu-item">
	        <a href="/Search/">Search</a></li>
	
        <li id="menu-item-6" class="menu-item">
            <a href="/Contact/">Contact</a></li>

        <li id="menu-item-7" class="menu-item">
	        <a href="http://axelradio.com/">Music</a></li>
        
    </ul>	
</div><!-- /#navigation -->
		</div>
		<div id="bd" class="container">
			<h2 class="title">
                solr shell scripting for fun and profit
            </h2>
			<p class="teaser_info"><p>We love Solr. Yes we do.</p><br />
<br />
<br />
<p>#!/bin/bash<br /><br />
#<br /><br />
# Shell script to clean up backups of a Solr Lucene collection.</p><br />
<br />
<br />
<p>orig_dir=$(pwd)<br /><br />
cd ${0%/*}/..<br /><br />
solr_root=$(pwd)<br /><br />
cd ${orig_dir}</p><br />
<br />
<br />
<p>unset days num data_dir user verbose debug<br /><br />
. ${solr_root}/bin/scripts-util</p><br />
<br />
<br />
<p># set up variables<br /><br />
prog=${0##*/}<br /><br />
log=${solr_root}/logs/${prog}.log</p><br />
<br />
<br />
<p># define usage string<br /><br />
USAGE="\<br /><br />
usage: $prog -D  | -N  [-d dir] [-u username] [-v]<br /><br />
       -D    cleanup backups more than  days old<br /><br />
       -N     keep the most recent  number of backups and<br /><br />
                   cleanup up the remaining ones that are not being pulled<br /><br />
       -d          specify directory holding index data<br /><br />
       -u          specify user to sudo to before running script<br /><br />
       -v          increase verbosity<br /><br />
       -V          output debugging info<br /><br />
"</p><br />
<br />
<br />
<p># parse args<br /><br />
while getopts D:N:d:u:vV OPTION<br /><br />
do<br /><br />
    case $OPTION in<br /><br />
    D)<br /><br />
        days="$OPTARG"<br /><br />
        ;;<br /><br />
    N)<br /><br />
        num="$OPTARG"<br /><br />
        ;;<br /><br />
    d)<br /><br />
        data_dir="$OPTARG"<br /><br />
        ;;<br /><br />
    u)<br /><br />
        user="$OPTARG"<br /><br />
        ;;<br /><br />
    v)<br /><br />
        verbose="v"<br /><br />
        ;;<br /><br />
    V)<br /><br />
        debug="V"<br /><br />
        ;;<br /><br />
    *)<br /><br />
        echo "$USAGE"<br /><br />
        exit 1<br /><br />
    esac<br /><br />
done</p><br />
<br />
<br />
<p>[[ -n $debug ]] &amp;&amp; set -x</p><br />
<br />
<br />
<p>if [[ -z ${days} &amp;&amp; -z ${num} ]]<br /><br />
then<br /><br />
    echo "$USAGE"<br /><br />
    exit 1<br /><br />
fi</p><br />
<br />
<br />
<p>fixUser "$@"</p><br />
<br />
<br />
<p># use default value for data_dir if not specified<br /><br />
# relative path starts at ${solr_root}<br /><br />
if [[ -z ${data_dir} ]]<br /><br />
then<br /><br />
    data_dir=${solr_root}/data<br /><br />
elif [[ "`echo ${data_dir}|cut -c1`" != "/" ]]<br /><br />
then<br /><br />
    data_dir=${solr_root}/${data_dir}<br /><br />
fi</p><br />
<br />
<br />
<p>function remove<br /><br />
{<br /><br />
    logMessage removing backup $1<br /><br />
    /bin/rm -rf $1<br /><br />
}</p><br />
<br />
<br />
<p>start=`date +"%s"`</p><br />
<br />
<br />
<p>logMessage started by $oldwhoami<br /><br />
logMessage command: $0 $@</p><br />
<br />
<br />
<p># trap control-c<br /><br />
trap &#039;echo "caught INT/TERM, exiting now but partial cleanup may have already occured";logExit aborted 13&#039; INT TERM</p><br />
<br />
<br />
<p>if [[ -n ${days} ]]<br /><br />
then<br /><br />
    #is maxdepth supported?<br /><br />
    find ${data_dir} -maxdepth 0 -name foobar &gt;/dev/null 2&gt;&amp;1<br /><br />
    if [ $? = 0 ]; then<br /><br />
      maxdepth="-maxdepth 1"<br /><br />
    else<br /><br />
      unset maxdepth<br /><br />
    fi</p><br />
<br />
<br />
<p>    logMessage cleaning up backups more than ${days} days old<br /><br />
    for i in `find ${data_dir} ${maxdepth} -name &#039;backup.*&#039; -mtime +${days} -print`<br /><br />
    do<br /><br />
        remove $i<br /><br />
    done<br /><br />
elif [[ -n ${num} ]]<br /><br />
then<br /><br />
    logMessage cleaning up all backups except for the most recent ${num} ones<br /><br />
    unset backups count<br /><br />
    backups=`ls -cd ${data_dir}/backup.* 2&gt;/dev/null`<br /><br />
    if [[ $? == 0 ]]<br /><br />
    then<br /><br />
        count=`echo $backups|wc -w`<br /><br />
        startpos=`expr $num + 1`<br /><br />
        if [[ $count -gt $num ]]<br /><br />
        then<br /><br />
            for i in `echo $backups|cut -f${startpos}- -d" "`<br /><br />
            do<br /><br />
            remove $i<br /><br />
        done<br /><br />
        fi<br /><br />
    fi<br /><br />
fi</p><br />
<br />
<br />
<p>logExit ended 0</p><br />
<br />
<br />
<p><a href="http://www.digbox.net/index.php/RoR/solr-shell-scripting-for-fun-and-profit">Original post</a> blogged on <a href="http://codeboxer.com">codeboxer.com</a>.</p><br />
<br />
</p>
			<div class="post-meta">
                <span class="small">By</span> <span class="author vcard"><span class="fn"><a href="http://kristeraxel.com" title="Posts by Krister Axel" rel="author">Krister Axel</a></span></span> 
                <span class="small">on</span> <abbr class="date time published">02/27 2008 at 08_02</abbr> 
                <span class="small">in</span> 
                <span class="categories">
                    
						<a href="/category/code/">code</a> 
                    
                </span>
            </div>
		</div>
		<div id="ft">
			<br/>
<hr/>
<table id="footer">
	<tr>
	  <td><span class="leftcol">
	    <ul>
	      <li><a href="http://www.kristeraxel.com" rel="me" title="my home page" target="_blank">kristeraxel.com</a></li>
	      <li><a href="http://axelradio.com" rel="me" title="Download songs by Krister Axel and read the lyrics." target="_blank">Lyrics + Downloads</a></li>
	      <li><a href="http://axel.me/mouse" rel="me" title="view my media stream at rebelmouse" target="_blank">videos</a></li>
	    </ul>
		</span>
	  </td>
	  <td><span class="midcol">
	    <small>&copy; 29 November 2012 Krister Axel<br/>All Rights Reserved.</small>
		</span>
	  </td>
	  <td><span class="rightcol">
	    <small>designed by <a href="http://kristeraxel.com">Krister Axel</a><br/>powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a></small>
		</span>
	  </td>
	</tr>
	
</table>
		</div>
	</div>
	  <script>
	  audiojs.events.ready(function() {
	    var as = audiojs.createAll();
	  });
	  </script>
	</body>

</html>