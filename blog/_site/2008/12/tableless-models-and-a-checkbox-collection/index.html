<!DOCTYPE html>
<html dir="ltr" lang="en-US">
    <head>
        <meta charset="UTF-8" />
        <title>Tableless models and a checkbox collection | Krister Axel</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0; maximum-scale=1.0; user-scalable=yes" name="viewport"/>

<!-- Custom Favicon -->
<link rel="shortcut icon" href="http://blog.kristeraxel.com/wp-content/uploads/2012/11/favicon.ico"/>

<!-- style sheets -->
<link rel="stylesheet" type="text/css" href="/css/style.css" media="all" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?2.9.0/build/reset-fonts-grids/reset-fonts-grids.css&2.9.0/build/base/base-min.css"> 

    </head>

    <body>
	<!-- the id on the containing div determines the page width. -->
	<!-- #doc = 750px; #doc2 = 950px; #doc3 = 100%; #doc4 = 974px -->
	<div id="doc">					
		<div id="hd">
			<div id="header" class="col-full">

   
   <div id="logo">
        <a href="/" title="spotlights in the wild">
            <img src="http://blog.kristeraxel.com/wp-content/uploads/2012/11/header11.jpg" alt="Krister Axel" />
        </a>
   </div><!-- /#logo -->
   
</div><!-- /#header -->
<div id="navigation" class="col-full">
	<ul id="main-nav" class="nav">
		<li id="menu-item-9" class="menu-item">
		    <a href="/" >the latest</a></li>
		
		<li id="menu-item-9999" class="menu-item">
	        <a href="/Archive/">Archive</a></li>
	
		<li id="menu-item-99" class="menu-item">
		    <a href="/Info/" >Info</a></li>

		<li id="menu-item-99999" class="menu-item">
            <a href="/Press/" >Press</a></li>

		<li id="menu-item-999999" class="menu-item">
	        <a href="/Search/">Search</a></li>
	
        <li id="menu-item-999999" class="menu-item">
            <a href="/Contact/">Contact</a></li>
        
    </ul>	
</div><!-- /#navigation -->
		</div>
		<div id="bd" class="container">
			<h2 class="title">
                Tableless models and a checkbox collection
            </h2>
			<p>I have always loved the sound of a table-less model. It feels so dirty. Here is one from the school of hard knocks, known as the Merchant model:</p><br />
<br />
<br />
<p>class Merchant &lt; ActiveRecord::Base<br /><br />
  def self.columns() @columns ||= []; end</p><br />
<br />
<br />
<p>  def self.column(name, sql_type = nil, default = nil, null = true)<br /><br />
    columns &lt;&lt; ActiveRecord::ConnectionAdapters::Column.new(name.to_s, default, sql_type.to_s, null)<br /><br />
  end</p><br />
<br />
<br />
<p>  column :merchant, :string<br /><br />
  validates_presence_of :merchant</p><br />
<br />
<br />
<p>  def self.get_edit_values(page_id)<br /><br />
    new_arr = []<br /><br />
    Summary.find_by_sql(["<br /><br />
      SELECT merchant, CASE LENGTH(selected) &gt; 0 WHEN TRUE THEN 1 ELSE 0 END value FROM<br /><br />
        (SELECT value merchant, merchant selected<br /><br />
        FROM<br /><br />
          (SELECT merchant from merchant_pages where page_id=?) signed_up<br /><br />
            RIGHT JOIN (SELECT DISTINCT MERCHANT value FROM retailers) distinct_m<br /><br />
                    ON distinct_m. value = signed_up. merchant) new_alias<br /><br />
    ORDER BY merchant<br /><br />
      ", page_id.to_i]).each do |x|<br /><br />
                    new_arr &lt;&lt; [x.merchant, x.value]<br /><br />
                  end<br /><br />
                  new_arr<br /><br />
  end</p><br />
<br />
<br />
<p>  def self.get_values<br /><br />
    Summary.find_by_sql(["<br /><br />
      SELECT DISTINCT MERCHANT value FROM retailers order by merchant<br /><br />
      "]).each do |x|<br /><br />
      @columns &lt;&lt; x.value<br /><br />
    end<br /><br />
    @columns<br /><br />
  end</p><br />
<br />
<br />
<p>end</p><br />
<br />
<br />
<p>Of course, it does hit the database, but there is no Merchants table, per se, there is just this model. What returns from a &#039;SELECT * FROM MERCHANTS&#039; is the distinct selection for the value of &#039;merchant&#039; from the Retailers table. These come in from the partners, and they are very consistent. I can&#039;t tell you how helpful this is. The system auto-magically created a Target.com that showed up immediately alongside it&#039;s older bother, Target. Watch out, however, for cache-ing concerns that will necessarily stem from this approach in terms of scale - in this case, that was not a concern because we have a very small (but highly lucrative) user base.</p><br />
<br />
<br />
<p>This is the corresponding controller code. This is from the pages_controller, because there is no direct merchants_controller.</p><br />
<br />
<br />
<p>       def update<br /><br />
        @page = Page.find(params[:id])</p><br />
<br />
<br />
<p>         if @page.update_attributes(params[:page])<br /><br />
          if dump_all_merchant_pages(@page.id)<br /><br />
            params[:merchants].each do |p|<br /><br />
              create_or_update_merchant_page(p[0].to_s, @page.id, true)<br /><br />
            end<br /><br />
          end<br /><br />
          flash[:notice] = &#039;Page was successfully updated.&#039;<br /><br />
          redirect_to pages_path<br /><br />
        else<br /><br />
          render :action =&gt; &#039;edit&#039;<br /><br />
        end<br /><br />
      end</p><br />
<br />
<br />
<p>the functions, from the bottom of the page:</p><br />
<br />
<br />
<p>     private<br /><br />
      def dump_all_merchant_pages(page_id)<br /><br />
        Page.find(page_id).merchant_pages.each do |x|<br /><br />
          x.destroy<br /><br />
        end<br /><br />
        true<br /><br />
      end</p><br />
<br />
<br />
<p>       def create_or_update_merchant_page(m, p, val)<br /><br />
        x = MerchantPage.find_by_sql(["SELECT merchant<br /><br />
                                             FROM merchant_pages<br /><br />
                                            WHERE merchant = ?<br /><br />
                                              AND page_id = ? LIMIT 1", m, p])<br /><br />
        if !x.first<br /><br />
          x = MerchantPage.new(:merchant =&gt; m, :page_id =&gt; p)<br /><br />
          x.save<br /><br />
        else<br /><br />
          if !val<br /><br />
            x.destroy<br /><br />
          end<br /><br />
          true<br /><br />
        end<br /><br />
      end</p><br />
<br />
<br />
<p>Finally, the _page partial:</p><br />
<br />
<br />
<p>form_for ([@page]) do |f|<br /><br />
  Page Name<br /><br />
    f.text_field :title, :size =&gt; 60<br /><br />
    Main Content<br /><br />
    f.text_area :page_body, :cols =&gt; 100<br /><br />
    Locator Footer (Link back to Partner homepage)<br /><br />
    f.text_area :page_footer, :cols =&gt; 100, :rows =&gt; 5<br /><br />
  Merchants<br /><br />
  ul class="Merchant-list"<br /><br />
      if button_name=="Save Changes"<br /><br />
        @merchants.each do |m|<br /><br />
            li INPUT type="checkbox" name="merchants[&lt;=m[0]%&gt;][]" &lt;=m[1]=="1" ? "checked" : "" label m[0].to_s /label<br /><br />
        end<br /><br />
      else<br /><br />
        @merchants.each do |m|<br /><br />
          li INPUT type="checkbox" name="merchants[&lt;=m&gt;][]"/&gt; &lt;=m.to_s /label<br /><br />
        end<br /><br />
      end<br /><br />
    /ul<br /><br />
    f.submit button_name<br /><br />
  end<a href="http://www.digbox.net/index.php/RoR/tableless-models-and-a-checkbox-collecti">Original post</a> blogged on <a href="http://codeboxer.com">codeboxer.com</a>.</p><br />
<br />

			<div class="post-meta">
                <span class="small">By</span> <span class="author vcard"><span class="fn"><a href="http://kristeraxel.com" title="Posts by Krister Axel" rel="author">Krister Axel</a></span></span> 
                <span class="small">on</span> <abbr class="date time published">12/05 2008 at 01_44</abbr> 
                <span class="small">in</span> 
                <span class="categories">
                    
						<a href="/category/Code/">Code</a> 
                    
                </span>
            </div>
		</div>
		<div id="ft">
			<br/>
<hr/>
<table id="footer">
	<tr>
	  <td><span class="leftcol">
	    <ul>
	      <li><a href="http://www.kristeraxel.com" rel="me" title="my home page" target="_blank">kristeraxel.com</a></li>
	      <li><a href="http://axelradio.com" rel="me" title="Download songs by Krister Axel and read the lyrics." target="_blank">Lyrics + Downloads</a></li>
	    </ul>
		</span>
	  </td>
	  <td><span class="midcol">
	    <small>&copy; 25 November 2012 Krister Axel<br/>All Rights Reserved.</small>
		</span>
	  </td>
	  <td><span class="rightcol">
	    <small>designed by <a href="http://kristeraxel.com">Krister Axel</a><br/>powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a></small>
		</span>
	  </td>
	</tr>
	
</table>
		</div>
	</div>
	</body>

</html>