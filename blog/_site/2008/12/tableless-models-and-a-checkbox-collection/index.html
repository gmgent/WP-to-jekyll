<!DOCTYPE html>
<html dir="ltr" lang="en-US">
    <head>
        <meta charset="UTF-8" />
        <title>Krister Axel</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="stylesheet" type="text/css" href="/css/style.css" media="all" />
		
        <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

        <!--  Mobile viewport scale -->
        <meta content="initial-scale=1.0; maximum-scale=1.0; user-scalable=yes" name="viewport"/>

        <!-- Custom Favicon -->
        <link rel="shortcut icon" href="http://blog.kristeraxel.com/wp-content/uploads/2012/11/favicon.ico"/>


    </head>
    <body class="home blog gecko boxed-layout two-col-left width-820 two-col-left-820">
        <div id="wrapper">
	    
	        <div id="header" class="col-full">

   
    <div id="logo">
        <a href="/" title="spotlights in the wild">
            <img src="http://blog.kristeraxel.com/wp-content/uploads/2012/11/header11.jpg" alt="Krister Axel" />
        </a>
        <h1 class="site-title"><a href="/">Krister Axel</a></h1>
        <span class="site-description">spotlights in the wild</span>
   </div><!-- /#logo -->

   <h3 class="nav-toggle icon"><a href="#navigation">Navigation</a></h3>

   
</div><!-- /#header -->
<div id="navigation" class="col-full">
	<ul id="main-nav" class="nav fl">
		<li id="menu-item-2302" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2302">
		    <a href="/Info/" >Info</a>
		</li>
        <li id="menu-item-2255" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2255">
            <a href="/archive/">Archive</a>
        </li>
		<li id="menu-item-2213" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2213">
            <a href="/Press/" >Press</a></li>
        <li id="menu-item-2212" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2212">
            <a href="http://blog.kristeraxel.com/contact/">Contact</a></li>
        
    </ul>	
</div><!-- /#navigation -->
      
            <!-- #content Starts -->
	        <div id="content" class="col-full">
    
    	        <div id="blog-main">
		
                <!-- #main Starts -->
                    <div id="main" class="col-left">
            	
			
                        <div class="post type-post status-publish format-standard">
                            <h2 class="title">
	                            Tableless models and a checkbox collection
	                        </h2>
	                        <div class="post-meta">
		                        <span class="small">By</span> <span class="author vcard"><span class="fn"><a href="http://kristeraxel.com" title="Posts by Krister Axel" rel="author">Krister Axel</a></span></span> 
		                        <span class="small">on</span> <abbr class="date time published">12/05 2008 at 01_44</abbr> 
		                        <span class="small">in</span> 
		                        <span class="categories">
			                        
										<a href="/category/Code/">Code</a> 
			                        
			                    </span>
		                    </div>
	                        <div class="entry">
	                            <p><p>I have always loved the sound of a table-less model. It feels so dirty. Here is one from the school of hard knocks, known as the Merchant model:</p>


<p>class Merchant &lt; ActiveRecord::Base<br />
  def self.columns() @columns ||= []; end</p>


<p>  def self.column(name, sql_type = nil, default = nil, null = true)<br />
    columns &lt;&lt; ActiveRecord::ConnectionAdapters::Column.new(name.to_s, default, sql_type.to_s, null)<br />
  end</p>


<p>  column :merchant, :string<br />
  validates_presence_of :merchant</p>


<p>  def self.get_edit_values(page_id)<br />
    new_arr = []<br />
    Summary.find_by_sql(["<br />
      SELECT merchant, CASE LENGTH(selected) &gt; 0 WHEN TRUE THEN 1 ELSE 0 END value FROM<br />
        (SELECT value merchant, merchant selected<br />
        FROM<br />
          (SELECT merchant from merchant_pages where page_id=?) signed_up<br />
            RIGHT JOIN (SELECT DISTINCT MERCHANT value FROM retailers) distinct_m<br />
                    ON distinct_m. value = signed_up. merchant) new_alias<br />
    ORDER BY merchant<br />
      ", page_id.to_i]).each do |x|<br />
                    new_arr &lt;&lt; [x.merchant, x.value]<br />
                  end<br />
                  new_arr<br />
  end</p>


<p>  def self.get_values<br />
    Summary.find_by_sql(["<br />
      SELECT DISTINCT MERCHANT value FROM retailers order by merchant<br />
      "]).each do |x|<br />
      @columns &lt;&lt; x.value<br />
    end<br />
    @columns<br />
  end</p>


<p>end</p>


<p>Of course, it does hit the database, but there is no Merchants table, per se, there is just this model. What returns from a &#039;SELECT * FROM MERCHANTS&#039; is the distinct selection for the value of &#039;merchant&#039; from the Retailers table. These come in from the partners, and they are very consistent. I can&#039;t tell you how helpful this is. The system auto-magically created a Target.com that showed up immediately alongside it&#039;s older bother, Target. Watch out, however, for cache-ing concerns that will necessarily stem from this approach in terms of scale - in this case, that was not a concern because we have a very small (but highly lucrative) user base.</p>


<p>This is the corresponding controller code. This is from the pages_controller, because there is no direct merchants_controller.</p>


<p>       def update<br />
        @page = Page.find(params[:id])</p>


<p>         if @page.update_attributes(params[:page])<br />
          if dump_all_merchant_pages(@page.id)<br />
            params[:merchants].each do |p|<br />
              create_or_update_merchant_page(p[0].to_s, @page.id, true)<br />
            end<br />
          end<br />
          flash[:notice] = &#039;Page was successfully updated.&#039;<br />
          redirect_to pages_path<br />
        else<br />
          render :action =&gt; &#039;edit&#039;<br />
        end<br />
      end</p>


<p>the functions, from the bottom of the page:</p>


<p>     private<br />
      def dump_all_merchant_pages(page_id)<br />
        Page.find(page_id).merchant_pages.each do |x|<br />
          x.destroy<br />
        end<br />
        true<br />
      end</p>


<p>       def create_or_update_merchant_page(m, p, val)<br />
        x = MerchantPage.find_by_sql(["SELECT merchant<br />
                                             FROM merchant_pages<br />
                                            WHERE merchant = ?<br />
                                              AND page_id = ? LIMIT 1", m, p])<br />
        if !x.first<br />
          x = MerchantPage.new(:merchant =&gt; m, :page_id =&gt; p)<br />
          x.save<br />
        else<br />
          if !val<br />
            x.destroy<br />
          end<br />
          true<br />
        end<br />
      end</p>


<p>Finally, the _page partial:</p>


<p>form_for ([@page]) do |f|<br />
  Page Name<br />
    f.text_field :title, :size =&gt; 60<br />
    Main Content<br />
    f.text_area :page_body, :cols =&gt; 100<br />
    Locator Footer (Link back to Partner homepage)<br />
    f.text_area :page_footer, :cols =&gt; 100, :rows =&gt; 5<br />
  Merchants<br />
  ul class="Merchant-list"<br />
      if button_name=="Save Changes"<br />
        @merchants.each do |m|<br />
            li INPUT type="checkbox" name="merchants[&lt;=m[0]%&gt;][]" &lt;=m[1]=="1" ? "checked" : "" label m[0].to_s /label<br />
        end<br />
      else<br />
        @merchants.each do |m|<br />
          li INPUT type="checkbox" name="merchants[&lt;=m&gt;][]"/&gt; &lt;=m.to_s /label<br />
        end<br />
      end<br />
    /ul<br />
    f.submit button_name<br />
  end<a href="http://www.digbox.net/index.php/RoR/tableless-models-and-a-checkbox-collecti">Original post</a> blogged on <a href="http://codeboxer.com">codeboxer.com</a>.</p>

</p>
	                        </div><!-- /.entry -->
		                    <div class="post-more">     
				                <span class="post-comments comments"><a href="/">
					            <span class="dsq-postid" rel="2333 http://blog.kristeraxel.com/?p=2333">Comments { 0 }</span></a></span>		
					        </div>                        	
	                    </div><!-- /.post -->
                
                    </div><!-- /#main -->
                
    
		        </div><!-- /#main-sidebar-container -->         

		       

            </div><!-- /#content -->
			
	
	
	    <div id="footer-widgets" class="col-full col-3">
					
	<div class="block footer-widget-1">
		<p><a href="/"><img src="/img/feed-icon-32x32.png"></a></p>
	</div>	        
	        					
	<div class="block footer-widget-2">
        <p>&copy; 24 November 2012 Krister Axel.<br/>All Rights Reserved. </p>
	</div>	        
	        					
	<div class="block footer-widget-3">
        <p>powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a> and designed by <a href="http://kristeraxel.com">Krister Axel</a></p>
	</div>	        
	<div class="fix"></div>
	
</div><!--/#footer-widgets-->
	
	    
	
	    </div><!-- /#wrapper -->
	
	

	</body>
</html>
